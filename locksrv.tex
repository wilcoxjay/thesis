\begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\$=3\catcode`\^=7\catcode`\_=8}]
\PY{c}{(*}\PY{c}{ 1 \PYZhy{} node identifiers }\PY{c}{*)}
\PY{n+nc}{Name} \PY{o}{:=} \PY{n+nc}{Server} \PY{o}{|} \PY{n+nc}{Agent}\PY{o}{(}\PY{k+kt}{int}\PY{o}{)}

\PY{c}{(*}\PY{c}{ 2 \PYZhy{} API, also known as external IO }\PY{c}{*)}
\PY{n+nc}{Inp} \PY{o}{:=} \PY{n+nc}{Lock} \PY{o}{|} \PY{n+nc}{Unlock}
\PY{n+nc}{Out} \PY{o}{:=} \PY{n+nc}{Grant}
\PY{c}{(*}\PY{c}{ 2 \PYZhy{} network messages }\PY{c}{*)}
\PY{n+nc}{Msg} \PY{o}{:=} \PY{n+nc}{LockMsg} \PY{o}{|} \PY{n+nc}{UnlockMsg} \PY{o}{|} \PY{n+nc}{GrantMsg}

\PY{c}{(*}\PY{c}{ 3 \PYZhy{} state }\PY{c}{*)}
\PY{n+nc}{State} \PY{o}{(}\PY{n}{n}\PY{o}{:} \PY{n+nc}{Name}\PY{o}{)} \PY{o}{:=}
  \PY{k}{match} \PY{n}{n} \PY{k}{with}
    \PY{o}{|} \PY{n+nc}{Server} \PY{o}{=\PYZgt{}} \PY{k+kt}{list} \PY{n+nc}{Name} \PY{c}{(*}\PY{c}{ head = agent holding lock      }\PY{c}{*)}
                          \PY{c}{(*}\PY{c}{ tail = agents waiting for lock }\PY{c}{*)}
    \PY{o}{|} \PY{n+nc}{Agent} \PY{n}{n} \PY{o}{=\PYZgt{}} \PY{k+kt}{bool}     \PY{c}{(*}\PY{c}{ true iff this agent holds lock }\PY{c}{*)}

\PY{n+nc}{InitState} \PY{o}{(}\PY{n}{n}\PY{o}{:} \PY{n+nc}{Name}\PY{o}{)} \PY{o}{:} \PY{n+nc}{State} \PY{n}{n} \PY{o}{:=}
  \PY{k}{match} \PY{n}{n} \PY{k}{with}
    \PY{o}{|} \PY{n+nc}{Server} \PY{o}{=\PYZgt{}} \PY{n+nb+bp}{[]}
    \PY{o}{|} \PY{n+nc}{Agent} \PY{n}{n} \PY{o}{=\PYZgt{}} \PY{n+nb+bp}{false}

\PY{c}{(*}\PY{c}{ 4 \PYZhy{} handler for external input }\PY{c}{*)}
\PY{n+nc}{HandleInp} \PY{o}{(}\PY{n}{n}\PY{o}{:} \PY{n+nc}{Name}\PY{o}{)} \PY{o}{(}\PY{n}{s}\PY{o}{:} \PY{n+nc}{State} \PY{n}{n}\PY{o}{)} \PY{o}{(}\PY{n}{inp}\PY{o}{:} \PY{n+nc}{Inp}\PY{o}{)} \PY{o}{:=}
  \PY{k}{match} \PY{n}{n} \PY{k}{with}
    \PY{o}{|} \PY{n+nc}{Server} \PY{o}{=\PYZgt{}} \PY{n}{nop}   \PY{c}{(*}\PY{c}{ server performs no external IO }\PY{c}{*)}
    \PY{o}{|} \PY{n+nc}{Agent} \PY{n}{n} \PY{o}{=\PYZgt{}}
      \PY{k}{match} \PY{n}{inp} \PY{k}{with}
        \PY{o}{|} \PY{n+nc}{Lock} \PY{o}{=\PYZgt{}}                     \PY{c}{(*}\PY{c}{ client requests lock   }\PY{c}{*)}
          \PY{n}{send} \PY{o}{(}\PY{n+nc}{Server}\PY{o}{,} \PY{n+nc}{LockMsg}\PY{o}{)}      \PY{c}{(*}\PY{c}{ forward to Server      }\PY{c}{*)}
        \PY{o}{|} \PY{n+nc}{Unlock} \PY{o}{=\PYZgt{}}                   \PY{c}{(*}\PY{c}{ client requests unlock }\PY{c}{*)}
          \PY{k}{if} \PY{n}{s} \PY{o}{=}\PY{o}{=} \PY{n+nb+bp}{true} \PY{k}{then} \PY{o}{(}         \PY{c}{(*}\PY{c}{ if lock held           }\PY{c}{*)}
            \PY{n}{s} \PY{o}{:=} \PY{n+nb+bp}{false}\PY{o}{;;}              \PY{c}{(*}\PY{c}{ update state           }\PY{c}{*)}
            \PY{n}{send} \PY{o}{(}\PY{n+nc}{Server}\PY{o}{,} \PY{n+nc}{UnlockMsg}\PY{o}{)}\PY{o}{)} \PY{c}{(*}\PY{c}{ tell Server lock freed }\PY{c}{*)}

\PY{c}{(*}\PY{c}{ 4 \PYZhy{} handler for network messages }\PY{c}{*)}
\PY{n+nc}{HandleMsg} \PY{o}{(}\PY{n}{n}\PY{o}{:} \PY{n+nc}{Name}\PY{o}{)} \PY{o}{(}\PY{n}{s}\PY{o}{:} \PY{n+nc}{State} \PY{n}{n}\PY{o}{)} \PY{o}{(}\PY{n}{src}\PY{o}{:} \PY{n+nc}{Name}\PY{o}{)} \PY{o}{(}\PY{n}{msg}\PY{o}{:} \PY{n+nc}{Msg}\PY{o}{)} \PY{o}{:=}
  \PY{k}{match} \PY{n}{n} \PY{k}{with}
    \PY{o}{|} \PY{n+nc}{Server} \PY{o}{=\PYZgt{}}
      \PY{k}{match} \PY{n}{msg} \PY{k}{with}
        \PY{o}{|} \PY{n+nc}{LockMsg} \PY{o}{=\PYZgt{}}
          \PY{c}{(*}\PY{c}{ if lock not held, immediately grant }\PY{c}{*)}
          \PY{k}{if} \PY{n}{s} \PY{o}{=}\PY{o}{=} \PY{n+nb+bp}{[]} \PY{k}{then} \PY{n}{send} \PY{o}{(}\PY{n}{src}\PY{o}{,} \PY{n+nc}{GrantMsg}\PY{o}{)}\PY{o}{;;}
          \PY{c}{(*}\PY{c}{ add requestor to end of queue }\PY{c}{*)}
          \PY{n}{s} \PY{o}{:=} \PY{n}{s} \PY{o}{+}\PY{o}{+} \PY{o}{[}\PY{n}{src}\PY{o}{]}
        \PY{o}{|} \PY{n+nc}{UnlockMsg} \PY{o}{=\PYZgt{}}
          \PY{c}{(*}\PY{c}{ head of queue no longer holds lock }\PY{c}{*)}
          \PY{n}{s} \PY{o}{:=} \PY{n}{tail} \PY{n}{s}\PY{o}{;;}
          \PY{c}{(*}\PY{c}{ grant lock to next waiting agent, if any }\PY{c}{*)}
          \PY{k}{if} \PY{n}{s} \PY{o}{!=} \PY{n+nb+bp}{[]} \PY{k}{then} \PY{n}{send} \PY{o}{(}\PY{n}{head} \PY{n}{s}\PY{o}{,} \PY{n+nc}{GrantMsg}\PY{o}{)}
        \PY{o}{|} \PY{o}{\PYZus{}} \PY{o}{=\PYZgt{}} \PY{n}{nop} \PY{c}{(*}\PY{c}{ never happens }\PY{c}{*)}
    \PY{o}{|} \PY{n+nc}{Agent} \PY{n}{n} \PY{o}{=\PYZgt{}}
      \PY{k}{match} \PY{n}{msg} \PY{k}{with}
        \PY{o}{|} \PY{n+nc}{GrantMsg} \PY{o}{=\PYZgt{}}      \PY{c}{(*}\PY{c}{ lock acquired    }\PY{c}{*)}
          \PY{n}{s} \PY{o}{:=} \PY{n+nb+bp}{true}\PY{o}{;;}      \PY{c}{(*}\PY{c}{ update state     }\PY{c}{*)}
          \PY{n}{output} \PY{n+nc}{Grant}     \PY{c}{(*}\PY{c}{ notify listeners }\PY{c}{*)}
        \PY{o}{|} \PY{o}{\PYZus{}} \PY{o}{=\PYZgt{}} \PY{n}{nop}         \PY{c}{(*}\PY{c}{ never happens    }\PY{c}{*)}
\end{Verbatim}
